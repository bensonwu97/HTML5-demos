<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" href="demo.css">
  <title>图片裁剪</title>
</head>
<body>

    <input type="file" id="file" value="选择图片" accept="image/*" >
    <div id="show-box">
      <div id="move-box"></div>
      <div id="clip-box"></div>
    </div>
    <button id="upload">上传</button>

</body>
<script src="demo.js"></script>
<script>

  window.onload = ()=>{
    init();
  }
  function init(){
    selectImage();
  }

  function selectImage(){
    const fileBtn = $('file');
    fileBtn.addEventListener('change',function(){
      const files = Array.from(this.files)

      files.forEach(file =>{
        let reader = new FileReader();

        reader.onload = function(){
          let result = this.result;
          loadImage(result).then(img=>{
            $('move-box').appendChild(img)
            addMoveImageEvents($('move-box'))
            $('upload').addEventListener('click',()=>{
              const toBaseImage = clipImage(img,$('clip-box'),$('move-box'))();
              loadImage( toBaseImage ).then(img=>{
                img.className = 'clip-image'
                document.body.appendChild(img)
              } )
            })
          })
        }
        reader.onerror = e =>{
          console.log(e)
        }
        reader.readAsDataURL(file)
      })
    })
  }
  function addMoveImageEvents( element ){
    let isDown = false;
    let mouseX = 0;
    let mouseY = 0;

    element.addEventListener('mousedown',e =>{
      e.preventDefault();
      isDown = true;
      mouseX = e.pageX - getXY($('move-box')).x;
      mouseY = e.pageY - getXY($('move-box')).y;
    })
    element.addEventListener('mousemove',e =>{
            e.preventDefault();
      let moveOffsetX,moveOffsetY = 0;
      if(isDown === true){
            moveOffsetX = e.pageX - mouseX,
            moveOffsetY = e.pageY - mouseY;
        element.style.transform = `translate3d(${moveOffsetX}px,${moveOffsetY}px,0)`
      }
    })
    element.addEventListener('mouseup',e=>{
      e.preventDefault();
      isDown = false;
    })
    element.addEventListener('mouseout',e=>{
      e.preventDefault();
      isDown = false;
    })
  }

  //裁剪图片
  function clipImage( img,clipEle,showEle,text = '头像' ){
    let scale = 1;
    const {canvas,cxt} = createCanvas();    //图片canvas
    const {canvas:watermaskCanvas,cxt:watermaskCxt} = createCanvas(); //水印canvas


    canvas.width = clipEle.offsetWidth;
    canvas.height = clipEle.offsetHeight;

    const sx = ( getXY(clipEle).x - getXY(showEle).x ) / scale,    //偏移坐标
          sy = ( getXY(clipEle).y - getXY(showEle).y  ) / scale;

    cxt.drawImage(img, sx,sy,canvas.width,canvas.height,0,0,canvas.width,canvas.height)
    //离屏canvas  将a canvas 画到b canvas上
     //绘制水印   在右下角
    cxt.drawImage(watermaskCanvas,canvas.width,canvas.height);

    watermaskCxt.font="bold 20px Microsoft YaHei";
    watermaskCxt.fillStyle="red";
    watermaskCxt.textBaseline="middle";
    watermaskCxt.fillText(text,30,30);

    document.body.appendChild(canvas);

    return function(){
      return canvas.toDataURL("image/png")
    }
  }

  //加水印
  function addWatermark( targetCanvas, text ){

  }

  function createCanvas(){
    let canvas = document.createElement('canvas'),
        cxt = canvas.getContext('2d');

    return {
      canvas,
      cxt
    }
  }



</script>
</html>
